{% extends 'base.html' %}
{% block title %}Личный кабинет | {{ user.username }}{% endblock %}

{% block content %}
<style>
    /* ✅ СТИЛИ ФОРМЫ ИЗ DASHBOARD */
    .form-section {
        background: linear-gradient(135deg, 
            rgba(15, 25, 45, 0.8) 0%, 
            rgba(10, 20, 40, 0.6) 100%);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        padding: 2.5rem;
        border: 1px solid rgba(0, 243, 255, 0.2);
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.05);
        position: relative;
        overflow: hidden;
        margin-bottom: 3rem;
    }

    .form-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(0, 243, 255, 0.8), 
            transparent);
    }

    .form-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(0, 153, 255, 0.2);
    }

    .form-icon {
        font-size: 2.2rem;
        color: #00f3ff;
        filter: drop-shadow(0 0 10px rgba(0, 243, 255, 0.3));
    }

    .form-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #ffffff;
        margin: 0;
    }

    .form-group {
        margin-bottom: 1.8rem;
        position: relative;
    }

    .form-group label {
        display: block;
        color: #80d4ff;
        font-weight: 600;
        margin-bottom: 0.8rem;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 1rem 1.2rem;
        background: rgba(25, 35, 55, 0.6);
        border: 1px solid rgba(0, 153, 255, 0.3);
        border-radius: 12px;
        color: #ffffff;
        font-size: 1rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .form-group input:focus,
    .form-group textarea:focus {
        background: rgba(35, 45, 70, 0.8);
        border-color: rgba(0, 243, 255, 0.6);
        outline: none;
        box-shadow: 
            0 0 0 3px rgba(0, 243, 255, 0.15),
            0 0 20px rgba(0, 243, 255, 0.2);
        transform: translateY(-2px);
    }

    .form-group textarea {
        min-height: 120px;
        resize: vertical;
    }

    .form-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 1rem 2.5rem;
        font-size: 1.1rem;
        font-weight: 700;
        background: linear-gradient(135deg, 
            rgba(0, 102, 255, 0.3) 0%, 
            rgba(0, 243, 255, 0.2) 100%);
        border: 2px solid transparent;
        border-image: linear-gradient(135deg, #0066ff, #00f3ff) 1;
        color: #ffffff;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 
            0 8px 25px rgba(0, 102, 255, 0.3),
            inset 0 0 0 1px rgba(255, 255, 255, 0.1);
    }

    .form-btn:hover {
        transform: translateY(-3px);
        box-shadow: 
            0 15px 35px rgba(0, 102, 255, 0.5),
            0 0 40px rgba(0, 243, 255, 0.3);
        background: linear-gradient(135deg, 
            rgba(0, 243, 255, 0.3) 0%, 
            rgba(0, 102, 255, 0.2) 100%);
        color: #00f3ff;
    }

    /* ✅ ВСЕ СТИЛИ ПРОФИЛЯ */
    .profile-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .profile-card {
        background: linear-gradient(135deg, 
            rgba(15, 25, 45, 0.7) 0%, 
            rgba(10, 20, 40, 0.5) 100%);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        padding: 3rem;
        border: 1px solid rgba(0, 243, 255, 0.2);
        box-shadow: 
            0 25px 50px -12px rgba(0, 0, 0, 0.4),
            0 0 40px rgba(0, 243, 255, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.05);
        position: relative;
        overflow: hidden;
        margin-bottom: 3rem;
    }

    .profile-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(0, 243, 255, 0.8), 
            transparent);
    }

    .profile-header {
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
    }

    .profile-avatar {
        width: 180px;
        height: 180px;
        margin: 0 auto 1.5rem;
        position: relative;
        border-radius: 50%;
        background: linear-gradient(135deg, 
            rgba(0, 102, 255, 0.2), 
            rgba(0, 243, 255, 0.1));
        border: 3px solid transparent;
        padding: 8px;
        box-shadow: 
            0 0 40px rgba(0, 243, 255, 0.3),
            inset 0 0 20px rgba(0, 243, 255, 0.1);
        animation: rotate-border 20s linear infinite;
    }

    .profile-avatar::before {
        content: '';
        position: absolute;
        inset: -3px;
        border-radius: 50%;
        background: linear-gradient(135deg, 
            #0066ff, 
            #00f3ff, 
            #0099ff, 
            #0066ff);
        z-index: -1;
        animation: rotate-gradient 3s linear infinite;
    }

    .profile-icon {
        width: 100%;
        height: 100%;
        background: rgba(10, 20, 40, 0.9);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4.5rem;
        color: #00f3ff;
        text-shadow: 0 0 25px #00f3ff;
    }

    .username {
        font-size: 2.8rem;
        font-weight: 800;
        background: linear-gradient(135deg, #00f3ff, #0099ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
        letter-spacing: 1px;
    }

    .user-role {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        background: rgba(0, 153, 255, 0.15);
        border-radius: 50px;
        border: 1px solid rgba(0, 243, 255, 0.3);
        color: #80d4ff;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 0 15px rgba(0, 153, 255, 0.2);
    }

    .user-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .info-card {
        background: rgba(20, 30, 50, 0.5);
        border-radius: 15px;
        padding: 1.5rem;
        border: 1px solid rgba(0, 153, 255, 0.2);
        transition: all 0.3s ease;
    }

    .info-card:hover {
        background: rgba(30, 40, 60, 0.6);
        border-color: rgba(0, 243, 255, 0.4);
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 243, 255, 0.15);
    }

    .info-label {
        color: #80d4ff;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-value {
        color: #ffffff;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .requests-section {
        margin-top: 3rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(0, 243, 255, 0.2);
    }

    .section-title {
        font-size: 2rem;
        color: #00f3ff;
        text-shadow: 0 0 15px rgba(0, 243, 255, 0.5);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .requests-count {
        background: rgba(0, 102, 255, 0.2);
        color: #80d4ff;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        border: 1px solid rgba(0, 153, 255, 0.3);
        font-weight: 600;
    }

    .requests-grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    }

    .request-card {
        background: rgba(15, 25, 45, 0.6);
        border-radius: 20px;
        padding: 1.8rem;
        border: 1px solid rgba(0, 153, 255, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .request-card:hover {
        background: rgba(20, 35, 60, 0.8);
        border-color: rgba(0, 243, 255, 0.5);
        transform: translateY(-8px);
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.4),
            0 0 40px rgba(0, 243, 255, 0.2);
    }

    .request-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        background: linear-gradient(180deg, #0066ff, #00f3ff);
    }

    .request-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.2rem;
    }

    .request-id {
        font-size: 1.5rem;
        font-weight: 800;
        color: #00f3ff;
        text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
    }

    .request-status {
        padding: 0.4rem 1rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .status-new { background: rgba(0, 255, 136, 0.15); color: #80ffd4; border: 1px solid rgba(0, 255, 136, 0.3); }
    .status-progress { background: rgba(255, 204, 0, 0.15); color: #fff5b3; border: 1px solid rgba(255, 204, 0, 0.3); }
    .status-ready { background: rgba(0, 153, 255, 0.15); color: #80d4ff; border: 1px solid rgba(0, 153, 255, 0.3); }
    .status-completed { background: rgba(102, 0, 255, 0.15); color: #ccb3ff; border: 1px solid rgba(102, 0, 255, 0.3); }

    .request-info {
        margin: 1.2rem 0;
    }

    .request-item {
        display: flex;
        justify-content: space-between;
        padding: 0.8rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .request-label {
        color: #80d4ff;
        font-size: 0.9rem;
    }

    .request-value {
        color: #ffffff;
        font-weight: 500;
        text-align: right;
        max-width: 60%;
        word-break: break-word;
    }

    .request-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .request-date {
        color: #94a3b8;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .request-actions {
        display: flex;
        gap: 0.8rem;
    }

    .action-btn {
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        border: 1px solid rgba(0, 153, 255, 0.3);
        background: rgba(0, 102, 255, 0.1);
        color: #80d4ff;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .action-btn:hover {
        background: rgba(0, 153, 255, 0.2);
        border-color: rgba(0, 243, 255, 0.5);
        color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 243, 255, 0.2);
    }

    .no-requests {
        text-align: center;
        padding: 4rem 2rem;
        background: rgba(15, 25, 45, 0.3);
        border-radius: 20px;
        border: 2px dashed rgba(0, 153, 255, 0.2);
    }

    .no-requests-icon {
        font-size: 4rem;
        color: rgba(0, 153, 255, 0.3);
        margin-bottom: 1.5rem;
    }

    .no-requests-text {
        color: #94a3b8;
        font-size: 1.2rem;
    }

    /* АНИМАЦИИ */
    @keyframes rotate-border {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes rotate-gradient {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    /* АДАПТИВНОСТЬ */
    @media (max-width: 768px) {
        .profile-container { padding: 1rem; }
        .profile-card { padding: 2rem 1.5rem; }
        .profile-avatar { width: 140px; height: 140px; }
        .profile-icon { font-size: 3.5rem; }
        .username { font-size: 2.2rem; }
        .user-info-grid,
        .requests-grid { grid-template-columns: 1fr; }
        .section-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
        .request-card { padding: 1.5rem; }
    }

    @media (max-width: 480px) {
        .profile-avatar { width: 120px; height: 120px; }
        .profile-icon { font-size: 3rem; }
        .username { font-size: 1.8rem; }
        .request-footer { flex-direction: column; gap: 1rem; align-items: flex-start; }
        .request-actions { width: 100%; justify-content: flex-start; }
    }
</style>

<div class="profile-container">
    <!-- ✅ ФОРМА СОЗДАНИЯ ЗАЯВКИ ТОЛЬКО ДЛЯ КЛИЕНТА -->
    {% if user.role == 'client' and request_form %}
    <div class="form-section">
        <div class="form-header">
            <div class="form-icon"><i class="fas fa-plus-circle"></i></div>
            <h3 class="form-title">Создать новую заявку</h3>
        </div>
        
        <form method="post">
            {% csrf_token %}
            {% for field in request_form %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">
                    <i class="fas fa-{% if field.name == 'climate_tech_type' %}snowflake 
                        {% elif field.name == 'climate_tech_model' %}tag 
                        {% elif field.name == 'problem_description' %}exclamation-triangle 
                        {% elif field.name == 'start_date' %}calendar-alt 
                        {% else %}cog {% endif %}me-1"></i>
                    {{ field.label }}
                </label>
                {{ field }}
                {% if field.errors %}
                <div style="color: #ff6b6b; font-size: 0.9rem; margin-top: 0.5rem;">
                    {{ field.errors }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
            <button type="submit" name="create_request" class="form-btn">
                <i class="fas fa-paper-plane me-2"></i> Отправить заявку
            </button>
        </form>
    </div>
    {% endif %}

    <!-- Профиль пользователя -->
    <div class="profile-card">
        <div class="profile-header">
            <div class="profile-avatar">
                <div class="profile-icon">
                    <i class="fas fa-user-astronaut"></i>
                </div>
            </div>
            
            <h1 class="username">{{ user.username|default:"Пользователь" }}</h1>
            
            <div class="user-role">
                <i class="fas fa-shield-alt me-1"></i>
                {{ user_role|default:"Пользователь" }}
            </div>
            
            <div class="user-info-grid">
                <div class="info-card">
                    <div class="info-label">
                        <i class="fas fa-id-card"></i>
                        Полное имя
                    </div>
                    <div class="info-value">
                        {{ user_fio|default:"Не указано" }}
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">
                        <i class="fas fa-phone"></i>
                        Телефон
                    </div>
                    <div class="info-value">
                        {{ user_phone|default:"Не указан" }}
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">
                        <i class="fas fa-envelope"></i>
                        Почта
                    </div>
                    <div class="info-value">
                        {{ user.email|default:"Не указана" }}
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">
                        <i class="fas fa-calendar-alt"></i>
                        Дата регистрации
                    </div>
                    <div class="info-value">
                        {{ user.date_joined|date:"d.m.Y"|default:"Неизвестно" }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Секция заявок -->
    <div class="requests-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-list-check"></i>
                Мои заявки
            </h2>
            
            <div class="requests-count">
                <i class="fas fa-hashtag me-1"></i>
                Всего: {{ requests|length|default:"0" }}
            </div>
        </div>

        {% if requests %}
        <div class="requests-grid">
            {% for request in requests %}
            <div class="request-card">
                <div class="request-header">
                    <div class="request-id">#{{ request.request_id|default:"000" }}</div>
                    <div class="request-status status-{{ request.request_status|default:'new' }}">
                        {% if request.request_status == 'new' %}Новая
                        {% elif request.request_status == 'in_progress' %}В работе
                        {% elif request.request_status == 'ready' %}Готова
                        {% elif request.request_status == 'completed' %}Завершена
                        {% else %}{{ request.request_status }}{% endif %}
                    </div>
                </div>
                
                <div class="request-info">
                    <div class="request-item">
                        <span class="request-label">Оборудование:</span>
                        <span class="request-value">{{ request.climate_tech_type|default:"Не указано" }}</span>
                    </div>
                    
                    <div class="request-item">
                        <span class="request-label">Модель:</span>
                        <span class="request-value">{{ request.climate_tech_model|default:"Не указана" }}</span>
                    </div>
                    
                    <div class="request-item">
                        <span class="request-label">Проблема:</span>
                        <span class="request-value">{{ request.problem_description|truncatechars:80|default:"Не описана" }}</span>
                    </div>
                    
                    {% if request.master %}
                    <div class="request-item">
                        <span class="request-label">Мастер:</span>
                        <span class="request-value">{{ request.master.fio|default:"Не назначен" }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="request-footer">
                    <div class="request-date">
                        <i class="far fa-calendar"></i>
                        {{ request.start_date|date:"d.m.Y"|default:"Не указана" }}
                    </div>
                    
                    <div class="request-actions">
                        <button class="action-btn">
                            <i class="fas fa-eye"></i>Просмотр
                        </button>
                        <button class="action-btn">
                            <i class="fas fa-comment"></i>Чат
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-requests">
            <div class="no-requests-icon">
                <i class="far fa-clipboard"></i>
            </div>
            <h3 class="no-requests-text">
                Заявок пока нет. {% if user.role == 'client' %}Создайте первую!{% else %}Обратитесь к администратору{% endif %}
            </h3>
        </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript анимации -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatar = document.querySelector('.profile-avatar');
    avatar.style.animation = 'float 6s ease-in-out infinite';
    
    const cards = document.querySelectorAll('.info-card, .request-card, .form-section');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 200 + (index * 100));
    });
    
    const actionBtns = document.querySelectorAll('.action-btn');
    actionBtns.forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(135deg, rgba(0, 153, 255, 0.3), rgba(0, 243, 255, 0.2))';
        });
        btn.addEventListener('mouseleave', function() {
            this.style.background = '';
        });
    });
});
</script>

{% endblock %}
